image: docker.latest
services:
  - docker(dind) # docker in docker

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci
  USER_GITLAB: khangaikhuu
  APP_NAME: clean-code-ci
  REPO: clean-architecture-demo

stages:
  - build
  - test
  - docker

maven-build:
  image: maven:3-jdk-8
  stage: build
  script: "mvn package -B"
  artifacts:
    paths:
      - target/*.jar
maven-test:
  image: maven:3-jdk-8
  stage: test
  script: "mvn clean test"

docker-build:
  stage: docker
  script:
    - docker login -u gitlab-ci-token -p yf5MDrLqi7ky1cyZ1qi_ registry.gitlab.com
    - docker build -t registry.gitlab.com/khangaikhuu/clean-architecture-demo .
    - docker push registry.gitlab.com/khangaikhuu/clean-architecture-demo